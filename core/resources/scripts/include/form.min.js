var Form=function(b){var a=this;this.form=$(b);this.optionals=JSON.parse(this.form.attr("data-optionals"));this.needsSave=false;this.updateUnused=function(c){$.each(a.optionals,function(f,e){if(typeof c=="undefined"||$.inArray(c.slice(0,-9),e)!==-1){inputs=$();$.each(e,function(h,g){inputs=inputs.add('[name="'+g+'"], [data-name="'+g+'"]')});var d=true;inputs.each(function(h,g){if($(g).val().length){d=false;return false}});if(d){inputs.addClass("unused")}else{inputs.removeClass("unused")}return(typeof c=="undefined")}})};this.input=function(c){var d=c.attr("name");if(typeof d=="undefined"){d=c.attr("data-name")}if(typeof d!="undefined"){a.updateUnused(d)}a.needsSave=true};this.intervalSave=function(){if(a.needsSave==true){a.needsSave=false;a.save()}};this.save=function(){a.form.find('input[type="hidden"]').each(function(d,f){f=$(f);var c=f.attr("name");if(typeof c!="undefined"){var e=[];a.form.find('[data-name="'+c+'"]').each(function(h,g){var j=$(g).val();if(j.length){e.push(j)}});if(e.length){if(f.attr("data-type")=="password"&&e.length==1){if(e[0]!="********"){f.val(Sha1.hash(e[0]))}}else{f.val(JSON.stringify(e))}}else{f.val("")}}});api(window.location.href,a.form.serialize(),a.success,a.responseError)};this.success=function(d){if(d.errors.length){var e=d.errors.join("<br>");var c=a.form.find(".form_errors");if(c.html()!=e){c.html(e).hide()}c.fadeIn()}else{a.form.find(".form_errors").hide()}if(d.item_errors.length){$.each(d.item_errors,function(j,f){var h=a.form.find('[name="'+f.name+'"], [data-name="'+f.name+'"]');h.addClass("invalid");var g=a.form.find('.form_item_error[data-for-name="'+f.name+'"]');if(g.find("span").text()!=f.error){g.hide();g.find("span").text(f.error)}g.fadeIn()})}else{a.form.find(".form_item_error").hide()}if(d.errors.length||d.item_errors.length){a.responseError()}else{if(d.redirect.length>0){window.location.href=d.redirect}else{a.responseSuccess()}}};this.responseSuccess=function(){a.form.find(".form_response > .error").hide();a.form.find(".form_response > .success").fadeIn("fast")};this.responseError=function(c){a.form.find(".form_response > .success").hide();a.form.find(".form_response > .error").fadeIn("fast")};if(!this.form.find('button[type="submit"]').length){setInterval(a.intervalSave,1000)}this.updateUnused();this.form.on("input","input",function(c){a.input($(c.currentTarget))});this.form.on("submit",function(c){c.preventDefault();a.save()});this.form.on("click","a.insert-link",function(){var c=$('[name="'+$(this).attr("data-for-name")+'"]');$.fancybox.open({type:"ajax",href:"/"+base_url+"admin/auxiliary/insert_link/",beforeShow:function(){$(".fancybox-skin").css("background","white")},beforeClose:function(){if($("#insert_submit").val()==1&&$("#insert_url").val()){var f=$("#insert_title").val();var d=$("#insert_url").val();var e=$("#insert_text").val();if(!e){e=$("#insert_title").val()}c.insertAtCaret("["+e+"]("+encodeURI(d)+' "'+f+'")');$('a[title="Preview"]').trigger("mouseup")}},helpers:{overlay:{locked:false}}})});this.form.on("click","a.insert-image",function(){var c=$('[name="'+$(this).attr("data-for-name")+'"]');$.fancybox.open({type:"ajax",href:"/"+base_url+"admin/auxiliary/insert_image/",beforeShow:function(){$(".fancybox-skin").css("background","white")},beforeClose:function(){if($("#insert_submit").val()==1&&$("#insert_url").val()){var i=$("#insert_title").val();var e=$("#insert_url").val();var h=$("#insert_text").val();var f=$("#insert_width").val();var d=$("#insert_position").val();if(!h){h=$("#insert_title").val()}if(f){e+="?w="+f}var g="!["+h+"]("+encodeURI(e)+' "'+i+'")';if(d){g='<span style="float:'+d+';">'+g+"</span>"}c.insertAtCaret(g);$('a[title="Preview"]').trigger("mouseup")}},helpers:{overlay:{locked:false}}})});this.form.on("click","a.insert-asset",function(){var c=$('[name="'+$(this).attr("data-for-name")+'"]');$.fancybox.open({type:"ajax",href:"/"+base_url+"admin/auxiliary/insert_asset/",beforeShow:function(){$(".fancybox-skin").css("background","white")},beforeClose:function(){if($("#insert_submit").val()==1&&$("#insert_url").val()){var f=$("#insert_title").val();var d=$("#insert_url").val();var e=$("#insert_text").val();if(!e){e=$("#insert_title").val()}c.insertAtCaret("["+e+"]("+encodeURI(d)+' "'+f+'")');$('a[title="Preview"]').trigger("mouseup")}},helpers:{overlay:{locked:false}}})})};$("form").each(function(a,b){new Form(b)});$('form input[data-type="password"]').each(function(b,a){a=$(a);if(a.val().length){$('form input[data-name="'+a.attr("name")+'"]').val("********")}});$('form input[data-type="array"]').each(function(c,g){g=$(g);var d=doT.template($("#"+g.attr("data-template")).text()),b=$("#"+g.attr("data-ul")),a=[];values=[];try{a=JSON.parse(g.attr("placeholder"));values=JSON.parse(g.val())}catch(f){}if(!values.length&&a.length){$.each(a,function(e,h){b.append(d({placeholder:h,value:""}))})}else{values.push("");$.each(values,function(e,h){b.append(d({placeholder:"",value:h}))})}b.on("input","input",function(j){var i=$(this),h=i.closest("li");if(i.val().length>0&&h.next().length==0){$(d({value:""})).appendTo(b).hide().fadeIn()}})});$('form input[data-type="parameters"]').each(function(c,g){g=$(g);var d=doT.template($("#"+g.attr("data-template")).text()),b=$("#"+g.attr("data-ul")),a=[];try{a=JSON.parse(g.val())}catch(f){}a.push("");$.each(a,function(e,h){b.append(d({key:e,value:h}))});b.on("input","input",function(j){var i=$(this),h=i.closest("li");if(i.val().length>0&&h.next().length==0){$(d({key:"",value:""})).appendTo(b).hide().fadeIn()}})});
var Form=function(f){var a=this;this.form=$(f);this.optionals=JSON.parse(this.form.attr("data-optionals"));this.hasChange=!1;this.saveTimeout=null;this.updateUnused=function(d){$.each(a.optionals,function(a,c){if("undefined"===typeof d||-1!==$.inArray(d,c)){inputs=$();$.each(c,function(a,d){inputs=inputs.add('[name="'+d+'"], [data-name="'+d+'"]')});var e=!0;inputs.each(function(a,d){if($(d).val().length)return e=!1});e?inputs.addClass("unused"):inputs.removeClass("unused");return"undefined"===typeof d}})};
this.updateUnused();this.form.on("input","input",function(d){apiStatusClear();d=$(d.currentTarget);var b=d.attr("name");"undefined"===typeof b?d.attr("data-name"):a.updateUnused(b);a.form.find('button[type="submit"]').length||a.needSave()});this.form.on("change","input",function(d){a.hasChange&&(clearTimeout(a.saveTimeout),a.save(),a.hasChange=!1)});this.needsSave=function(){a.hasChange=!0;clearTimeout(a.saveTimeout);a.saveTimeout=setTimeout(a.save,3E3)};this.save=function(){apiStatusWorking();a.hasChange=
!1;a.form.find('input[type="hidden"]').each(function(d,b){b=$(b);var c=b.attr("name");if("undefined"!==typeof c){var e=[];a.form.find('[data-name="'+c+'"]').each(function(a,d){var b=$(d).val();b.length&&e.push(b)});e.length?"password"==b.attr("data-type")&&1==e.length?"********"!=e[0]&&b.val(Sha1.hash(e[0])):b.val(JSON.stringify(e)):b.val("")}});api(window.location.href,a.form.serialize(),a.success,a.error)};this.success=function(d){if(d.errors.length){var b=d.errors.join("<br>"),c=a.form.find(".form_errors");
c.html()!=b&&c.html(b).hide();c.fadeIn()}else a.form.find(".form_errors").hide();d.item_errors.length?$.each(d.item_errors,function(d,b){a.form.find('[name="'+b.name+'"], [data-name="'+b.name+'"]').addClass("invalid");var c=a.form.find('.form_item_error[data-for-name="'+b.name+'"]');c.find("span").text()!=b.error&&(c.hide(),c.find("span").text(b.error));c.fadeIn()}):a.form.find(".form_item_error").hide();d.errors.length||d.item_errors.length?apiStatusError(d.response.error):0<d.redirect.length?window.location.href=
d.redirect:apiStatusSuccess(d.response.success)};this.error=function(a){apiStatusError()};this.form.on("submit",function(d){d.preventDefault();a.form.find('button[type="submit"]').length&&(a.form.find('button[type="submit"]').blur().attr("disabled","disabled"),setTimeout(function(){a.form.find('button[type="submit"]').removeAttr("disabled")},1E3));a.save()});this.form.on("click","a.insert-link",function(){var a=$('[name="'+$(this).attr("data-for-name")+'"]');$.fancybox.open({type:"ajax",href:"/"+
base_url+"admin/auxiliary/insert_link/",beforeShow:function(){$(".fancybox-skin").css("background","white")},beforeClose:function(){if(1==$("#insert_submit").val()&&$("#insert_url").val()){var b=$("#insert_title").val(),c=$("#insert_url").val(),e=$("#insert_text").val();e||(e=$("#insert_title").val());a.insertAtCaret("["+e+"]("+encodeURI(c)+' "'+b+'")');$('a[title="Preview"]').trigger("mouseup")}},helpers:{overlay:{locked:!1}}})});this.form.on("click","a.insert-image",function(){var a=$('[name="'+
$(this).attr("data-for-name")+'"]');$.fancybox.open({type:"ajax",href:"/"+base_url+"admin/auxiliary/insert_image/",beforeShow:function(){$(".fancybox-skin").css("background","white")},beforeClose:function(){if(1==$("#insert_submit").val()&&$("#insert_url").val()){var b=$("#insert_title").val(),c=$("#insert_url").val(),e=$("#insert_text").val(),g=$("#insert_width").val(),h=$("#insert_position").val();e||(e=$("#insert_title").val());g&&(c+="?w="+g);b="!["+e+"]("+encodeURI(c)+' "'+b+'")';h&&(b='<span style="float:'+
h+';">'+b+"</span>");a.insertAtCaret(b);$('a[title="Preview"]').trigger("mouseup")}},helpers:{overlay:{locked:!1}}})});this.form.on("click","a.insert-asset",function(){var a=$('[name="'+$(this).attr("data-for-name")+'"]');$.fancybox.open({type:"ajax",href:"/"+base_url+"admin/auxiliary/insert_asset/",beforeShow:function(){$(".fancybox-skin").css("background","white")},beforeClose:function(){if(1==$("#insert_submit").val()&&$("#insert_url").val()){var b=$("#insert_title").val(),c=$("#insert_url").val(),
e=$("#insert_text").val();e||(e=$("#insert_title").val());a.insertAtCaret("["+e+"]("+encodeURI(c)+' "'+b+'")');$('a[title="Preview"]').trigger("mouseup")}},helpers:{overlay:{locked:!1}}})})};$("form").each(function(f,a){new Form(a)});$('form input[data-type="password"]').each(function(f,a){a=$(a);a.val().length&&$('form input[data-name="'+a.attr("name")+'"]').val("********")});
$('form input[data-type="array"]').each(function(f,a){a=$(a);var d=doT.template($("#"+a.attr("data-template")).text()),b=$("#"+a.attr("data-ul")),c=[];values=[];try{c=JSON.parse(a.attr("placeholder")),values=JSON.parse(a.val())}catch(e){}!values.length&&c.length?$.each(c,function(a,c){b.append(d({placeholder:c,value:""}))}):(values.push(""),$.each(values,function(a,c){b.append(d({placeholder:"",value:c}))}));b.on("input","input",function(a){a=$(this);var c=a.closest("li");0<a.val().length&&0==c.next().length&&
$(d({value:""})).appendTo(b).hide().fadeIn()})});$('form input[data-type="parameters"]').each(function(f,a){a=$(a);var d=doT.template($("#"+a.attr("data-template")).text()),b=$("#"+a.attr("data-ul")),c=[];try{c=JSON.parse(a.val())}catch(e){}c.push("");$.each(c,function(a,c){b.append(d({key:a,value:c}))});b.on("input","input",function(a){a=$(this);var c=a.closest("li");0<a.val().length&&0==c.next().length&&$(d({key:"",value:""})).appendTo(b).hide().fadeIn()})});
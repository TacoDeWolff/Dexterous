var Draggable=function(b){var a=this;this.ul=$(b);this.needsSave=false;this.draggee=false;this.draggee_x_start=0;this.draggee_y_offset=0;this.placeholder=false;this.drag=function(l){if(a.draggee!==false){var c=a.ul.find("li:not(:first)").filter(function(){return $(this).css("position")=="static"});var n=l.pageY-a.draggee_y_offset;var o=c.first().offset().top+1;var h=c.last().offset().top+1;if(n<o){n=o}else{if(n>h){n=h}}var d=c.filter(function(){return !$(this).hasClass("placeholder")});if(d.length){var m=n+0.5*d.first().outerHeight();d.each(function(){var e=$(this);if(m>=e.offset().top&&m<e.offset().top+e.outerHeight()){if(n<a.placeholder.offset().top){a.placeholder.insertBefore(e)}else{a.placeholder.insertAfter(e)}return false}})}var f=0;var j=false;c.each(function(){var e=$(this);if(e.hasClass("placeholder")){return false}j=e});if(j!==false&&typeof j.attr("data-level")!="undefined"){f=Math.floor((l.pageX-a.draggee_x_start+20)/40);var k=j.attr("data-level");if(f>=k+2){f=k+1}}a.draggee.find(".icon-long-arrow-right").hide();for(var g=0;g<f;g++){a.draggee.find(".icon-long-arrow-right").eq(g).show()}a.draggee.css("top",n+"px");a.draggee.attr("data-level",f)}else{$(document).unbind("mousemove",a.drag)}};this.ul.on("mousedown",".icon-eye-open",function(f){f.preventDefault();var c=$(this).closest("li");c.toggleClass("unused");c.find("input").toggleClass("unused");var g=c.attr("data-level");var d=c.nextAll("li").filter(function(){return !$(this).hasClass("placeholder")}).each(function(){var e=$(this);if(e.attr("data-level")<=g){return false}if(e.hasClass("unused")!=c.hasClass("unused")){e.toggleClass("unused");e.find("input").toggleClass("unused")}});a.needsSave=true});this.ul.on("mousedown",".icon-reorder",function(c){c.preventDefault();if(a.draggee===false&&c.which==1){a.draggee=$(this).closest("li");a.draggee_x_start=c.pageX-$(".icon-long-arrow-right:visible",a.draggee).length*40;a.draggee_y_offset=c.pageY-(a.draggee.offset().top+1);a.placeholder=$("<li>").addClass("placeholder").insertAfter(a.draggee);a.draggee.addClass("draggee").css({top:(a.draggee.offset().top+1)+"px",left:a.draggee.offset().left+"px"});$(document).bind("mousemove",a.drag)}});$("html").mouseup(function(c){if(a.draggee!==false){c.preventDefault();$(document).unbind("mousemove",a.drag);a.draggee.insertAfter(a.placeholder).animate({top:(a.placeholder.offset().top+1)+"px"},"fast",function(){a.placeholder.remove();$(this).removeClass("draggee").css({top:"",left:""})});if(a.draggee.prev("li").attr("data-level")<a.draggee.attr("data-level")&&a.draggee.prev("li").hasClass("unused")&&!a.draggee.hasClass("unused")){a.draggee.toggleClass("unused");a.draggee.find("input").toggleClass("unused")}a.draggee=false;a.needsSave=true}});this.ul.on("keyup","input",function(){a.needsSave=true});this.intervalSave=function(){if(a.needsSave==true){a.needsSave=false;a.save()}};setInterval(a.intervalSave,1000);this.save=function(){$(".response > .success, .reponse > .error").hide();$(".response > .loading").fadeIn("fast").css("display","inline-block");var c=0;var e={};var d=$("li:not(:first)",a.ul).filter(function(){return !$(this).hasClass("placeholder")}).each(function(){var f=$(this);e[c]={link_id:f.attr("data-link-id"),level:f.attr("data-level"),name:f.find("input").val(),enabled:(f.hasClass("unused")?"0":"1")};c++});api("/"+base_url+"api/module/menu/index.php",{action:"modify_menu",menu:e},function(){$(".response > .loading").hide();$(".response > .success").fadeIn("fast")},function(){$(".response > .loading").hide();$(".response > .error").fadeIn("fast")})}};$("ul.draggable").each(function(b,a){new Draggable(a)});
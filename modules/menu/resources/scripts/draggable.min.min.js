var Draggable=function(f){var a=this;this.ul=$(f);this.hasChange=!1;this.saveTimeout=null;this.draggee=!1;this.draggee_y_offset=this.draggee_x_start=0;this.placeholder=!1;this.drag=function(b){if(!1!==a.draggee){var c=a.ul.find("li:not(:first)").filter(function(){return"static"==$(this).css("position")}),e=b.pageY-a.draggee_y_offset,d=c.first().offset().top+1,f=c.last().offset().top+1;e<d?e=d:e>f&&(e=f);d=c.filter(function(){return!$(this).hasClass("placeholder")});if(d.length){var h=e+0.5*d.first().outerHeight();
d.each(function(){var b=$(this);if(h>=b.offset().top&&h<b.offset().top+b.outerHeight())return e<a.placeholder.offset().top?a.placeholder.insertBefore(b):a.placeholder.insertAfter(b),!1})}var d=0,g=!1;c.each(function(){var a=$(this);if(a.hasClass("placeholder"))return!1;g=a});!1!==g&&"undefined"!==typeof g.attr("data-level")&&(d=Math.floor((b.pageX-a.draggee_x_start+20)/40),b=g.attr("data-level"),d>=b+2&&(d=b+1));a.draggee.find(".fa-long-arrow-right").hide();for(b=0;b<d;b++)a.draggee.find(".fa-long-arrow-right").eq(b).show();
a.draggee.css("top",e+"px");a.draggee.attr("data-level",d)}else $(document).unbind("mousemove",a.drag)};this.ul.on("mousedown",".fa-eye",function(b){b.preventDefault();apiStatusClear();var c=$(this).closest("li");c.toggleClass("unused");c.find("input").toggleClass("unused");var e=c.attr("data-level");c.nextAll("li").filter(function(){return!$(this).hasClass("placeholder")}).each(function(){var a=$(this);if(a.attr("data-level")<=e)return!1;a.hasClass("unused")!=c.hasClass("unused")&&(a.toggleClass("unused"),
a.find("input").toggleClass("unused"))});a.needsSave()});this.ul.on("mousedown",".fa-bars",function(b){b.preventDefault();apiStatusClear();!1===a.draggee&&1==b.which&&(a.draggee=$(this).closest("li"),a.draggee_x_start=b.pageX-40*$(".fa-long-arrow-right:visible",a.draggee).length,a.draggee_y_offset=b.pageY-(a.draggee.offset().top+1),a.placeholder=$("<li>").addClass("placeholder").insertAfter(a.draggee),a.draggee.addClass("draggee").css({top:a.draggee.offset().top+1+"px",left:a.draggee.offset().left+
"px"}),$(document).bind("mousemove",a.drag))});$("html").mouseup(function(b){!1!==a.draggee&&(b.preventDefault(),$(document).unbind("mousemove",a.drag),a.draggee.insertAfter(a.placeholder).animate({top:a.placeholder.offset().top+1+"px"},"fast",function(){a.placeholder.remove();$(this).removeClass("draggee").css({top:"",left:""})}),a.draggee.prev("li").attr("data-level")<a.draggee.attr("data-level")&&a.draggee.prev("li").hasClass("unused")&&!a.draggee.hasClass("unused")&&(a.draggee.toggleClass("unused"),
a.draggee.find("input").toggleClass("unused")),a.draggee=!1,a.needsSave())});this.ul.on("keyup","input",function(){apiStatusClear();a.needsSave()});this.ul.on("change","input",function(b){a.hasChange&&(clearTimeout(a.saveTimeout),a.save(),a.hasChange=!1)});this.needsSave=function(){a.hasChange=!0;clearTimeout(a.saveTimeout);a.saveTimeout=setTimeout(a.save,1E3)};this.save=function(){apiStatusWorking("Saving...");a.hasChange=!1;var b=0,c={};$("li:not(:first)",a.ul).filter(function(){return!$(this).hasClass("placeholder")}).each(function(){var a=
$(this);c[b]={link_id:a.attr("data-link-id"),level:a.attr("data-level"),name:a.find("input").val(),enabled:a.hasClass("unused")?"0":"1"};b++});api("/"+base_url+"api/module/menu/index.php",{action:"modify_menu",menu:c},function(){apiStatusSuccess("Saved")},function(){apiStatusError("Saving failed")})}};$("ul.draggable").each(function(f,a){new Draggable(a)});